services:
  bge-m3-embedding:
    container_name: bge-m3-tei
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.9
    restart: unless-stopped
    ports:
      - "${EMBEDDING_PORT}:80"
    volumes:
      # Cache directory for downloaded models
      - ./storage/embedding:/data
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
      - HF_HUB_VERBOSITY=debug
    command: >
      --model-id BAAI/bge-m3
      --pooling cls
      --max-concurrent-requests ${EMBEDDING_MAX_CONCURRENT_REQUESTS:-64}
      --max-batch-tokens ${EMBEDDING_MAX_BATCH_TOKENS:-4096}
      --max-client-batch-size ${EMBEDDING_MAX_CLIENT_BATCH_SIZE:-8}
      --max-batch-requests ${EMBEDDING_MAX_BATCH_REQUESTS:-16}
      --tokenization-workers ${EMBEDDING_TOKENIZATION_WORKERS:-2}
      --huggingface-hub-cache /data
    shm_size: 2g
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant_db
    ports:
      - "${QDRANT_HTTP_PORT}:6333"
      - "${QDRANT_GRPS_PORT}:6334"
    volumes:
      - ./storage/qdrant_storage:/qdrant/storage
    restart: unless-stopped
  rag-api:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: rag_api
    ports:
      - "${RAG_API_PORT}:8000"
    volumes:
      - ./server:/app/server
      - ./rag:/app/rag
    environment:
      - EMBEDDING_SERVICE_URL=http://bge-m3-embedding:80
      - QDRANT_URL=http://qdrant:6333
      - COLLECTION_NAME=${COLLECTION_NAME:-documents}
      - RAG_MODEL=${RAG_MODEL:-}
      - RAG_URL=${RAG_URL:-}
      - RAG_API_KEY=${RAG_API_KEY:-}
      - RAG_MAX_TOKENS=${RAG_MAX_TOKENS:-1024}
      - RAG_TEMPERATURE=${RAG_TEMPERATURE:-1.0}
    depends_on:
      - bge-m3-embedding
      - qdrant
    restart: unless-stopped
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: rag_web
    ports:
      - "${WEB_PORT:-3000}:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
    depends_on:
      - rag-api
    restart: unless-stopped